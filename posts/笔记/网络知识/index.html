<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>网络知识 - 运维个人技术栈</title><meta name=Description content="这里记录一些 ip, 包, 传输协议, 段, 和7 层网络知识等等网络知识, 方便快速查阅. "><meta property="og:title" content="网络知识"><meta property="og:description" content="这里记录一些 ip, 包, 传输协议, 段, 和7 层网络知识等等网络知识, 方便快速查阅. "><meta property="og:type" content="article"><meta property="og:url" content="https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-06T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="网络知识"><meta name=twitter:description content="这里记录一些 ip, 包, 传输协议, 段, 和7 层网络知识等等网络知识, 方便快速查阅. "><meta name=application-name content="kentxxq"><meta name=apple-mobile-web-app-title content="kentxxq"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/><link rel=prev href=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E6%96%87%E6%A1%A3%E5%8A%A9%E6%89%8B/><link rel=next href=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/point/redis/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"网络知识","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/kentxxq.com\/posts\/%E7%AC%94%E8%AE%B0\/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86\/"},"genre":"posts","keywords":"blog, 网络知识","wordcount":4706,"url":"https:\/\/kentxxq.com\/posts\/%E7%AC%94%E8%AE%B0\/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86\/","datePublished":"2023-07-06T00:00:00+00:00","dateModified":"2023-07-17T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"kentxxq"},"description":"这里记录一些 ip, 包, 传输协议, 段, 和7 层网络知识等等网络知识, 方便快速查阅. "}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=运维个人技术栈>运维个人技术栈</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Blog </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=运维个人技术栈>运维个人技术栈</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>Blog</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#内容>内容</a><ul><li><a href=#7-层通信>7 层通信</a></li><li><a href=#7-层模型各自的作用>7 层模型各自的作用</a></li><li><a href=#7-层网络协议>7 层网络协议</a></li><li><a href=#数据包详解>数据包详解</a><ul><li><a href=#数据包示意图>数据包示意图</a></li><li><a href=#数据链路层>数据链路层</a><ul><li><a href=#帧-frame>帧 frame</a><ul><li><a href=#以太网>以太网</a></li><li><a href=#wifi>WIFI</a></li></ul></li><li><a href=#mtu>MTU</a></li></ul></li><li><a href=#网络层>网络层</a><ul><li><a href=#tcp-ip-协议栈>TCP-IP 协议栈</a></li><li><a href=#ip-数据报格式>IP 数据报格式</a></li><li><a href=#ip-数据报分片>IP 数据报分片</a></li><li><a href=#私有-ip-地址>私有 IP 地址</a></li><li><a href=#arprarp-协议>ARP/RARP 协议</a></li><li><a href=#dhcp-协议>DHCP 协议</a></li><li><a href=#icmp-协议>ICMP 协议</a></li></ul></li><li><a href=#传输层>传输层</a><ul><li><a href=#udp>UDP</a></li><li><a href=#tcp>TCP</a><ul><li><a href=#tcp-的头部格式>TCP 的头部格式</a></li><li><a href=#tcp-options-相关参数>TCP-options 相关参数</a></li><li><a href=#tcp-建立连接>TCP 建立连接</a></li><li><a href=#tcp-连接释放>TCP 连接释放</a></li></ul></li></ul></li></ul></li></ul></li><li><a href=#faq>FAQ</a><ul><li><a href=#tcp-segment-段和-package-包>TCP segment 段和 package 包</a></li><li><a href=#tcp_cork-和-tcp_nodelay>TCP_CORK 和 TCP_NODELAY</a></li></ul></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">网络知识</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://kentxxq.com title=Author target=_blank rel="noopener noreferrer author" class=author>kentxxq</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/blog/><i class="far fa-folder fa-fw"></i>blog</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-07-06>2023-07-06</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-07-17>2023-07-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4706 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#内容>内容</a><ul><li><a href=#7-层通信>7 层通信</a></li><li><a href=#7-层模型各自的作用>7 层模型各自的作用</a></li><li><a href=#7-层网络协议>7 层网络协议</a></li><li><a href=#数据包详解>数据包详解</a><ul><li><a href=#数据包示意图>数据包示意图</a></li><li><a href=#数据链路层>数据链路层</a><ul><li><a href=#帧-frame>帧 frame</a><ul><li><a href=#以太网>以太网</a></li><li><a href=#wifi>WIFI</a></li></ul></li><li><a href=#mtu>MTU</a></li></ul></li><li><a href=#网络层>网络层</a><ul><li><a href=#tcp-ip-协议栈>TCP-IP 协议栈</a></li><li><a href=#ip-数据报格式>IP 数据报格式</a></li><li><a href=#ip-数据报分片>IP 数据报分片</a></li><li><a href=#私有-ip-地址>私有 IP 地址</a></li><li><a href=#arprarp-协议>ARP/RARP 协议</a></li><li><a href=#dhcp-协议>DHCP 协议</a></li><li><a href=#icmp-协议>ICMP 协议</a></li></ul></li><li><a href=#传输层>传输层</a><ul><li><a href=#udp>UDP</a></li><li><a href=#tcp>TCP</a><ul><li><a href=#tcp-的头部格式>TCP 的头部格式</a></li><li><a href=#tcp-options-相关参数>TCP-options 相关参数</a></li><li><a href=#tcp-建立连接>TCP 建立连接</a></li><li><a href=#tcp-连接释放>TCP 连接释放</a></li></ul></li></ul></li></ul></li></ul></li><li><a href=#faq>FAQ</a><ul><li><a href=#tcp-segment-段和-package-包>TCP segment 段和 package 包</a></li><li><a href=#tcp_cork-和-tcp_nodelay>TCP_CORK 和 TCP_NODELAY</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=简介 class=headerLink><a href=#%e7%ae%80%e4%bb%8b class=header-mark></a>简介</h2><p>这里记录一些 ip, 包, 传输协议, 段, 和 7 层网络知识等等网络知识, 方便快速查阅.</p><blockquote><p>参考资料
<a href=https://lfool.gitbook.io/computer-network/ target=_blank rel="noopener noreferrer">计算机网络 - Computer Network</a></p></blockquote><h2 id=内容 class=headerLink><a href=#%e5%86%85%e5%ae%b9 class=header-mark></a>内容</h2><h3 id=7-层通信 class=headerLink><a href=#7-%e5%b1%82%e9%80%9a%e4%bf%a1 class=header-mark></a>7 层通信</h3><p><img src=/posts/%E9%99%84%E4%BB%B6/7%E5%B1%82%E9%80%9A%E4%BF%A1.png></p><ul><li>路由器和 <code>3层交换机</code> 等价.</li><li><code>2层交换机</code> 活动在数据链路层, 只是延长网络.</li><li>每一层都加上自己的 <code>header头部数据</code>.</li></ul><h3 id=7-层模型各自的作用 class=headerLink><a href=#7-%e5%b1%82%e6%a8%a1%e5%9e%8b%e5%90%84%e8%87%aa%e7%9a%84%e4%bd%9c%e7%94%a8 class=header-mark></a>7 层模型各自的作用</h3><p><img src=/posts/%E9%99%84%E4%BB%B6/7%E5%B1%82%E6%A8%A1%E5%9E%8B%E5%90%84%E8%87%AA%E7%9A%84%E4%BD%9C%E7%94%A8.png></p><h3 id=7-层网络协议 class=headerLink><a href=#7-%e5%b1%82%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae class=header-mark></a>7 层网络协议</h3><p><img src=/posts/%E9%99%84%E4%BB%B6/7%E5%B1%82%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE.jpg></p><h3 id=数据包详解 class=headerLink><a href=#%e6%95%b0%e6%8d%ae%e5%8c%85%e8%af%a6%e8%a7%a3 class=header-mark></a>数据包详解</h3><h4 id=数据包示意图 class=headerLink><a href=#%e6%95%b0%e6%8d%ae%e5%8c%85%e7%a4%ba%e6%84%8f%e5%9b%be class=header-mark></a>数据包示意图</h4><p><img src=/posts/%E9%99%84%E4%BB%B6/%E6%95%B0%E6%8D%AE%E5%8C%85%E7%A4%BA%E6%84%8F%E5%9B%BE.png></p><h4 id=数据链路层 class=headerLink><a href=#%e6%95%b0%e6%8d%ae%e9%93%be%e8%b7%af%e5%b1%82 class=header-mark></a>数据链路层</h4><p><img src=/posts/%E9%99%84%E4%BB%B6/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82.png></p><h5 id=帧-frame class=headerLink><a href=#%e5%b8%a7-frame class=header-mark></a>帧 frame</h5><p><strong>帧首部和尾部的大小并不一定.</strong></p><h6 id=以太网 class=headerLink><a href=#%e4%bb%a5%e5%a4%aa%e7%bd%91 class=header-mark></a>以太网</h6><p><code>IEEE 802.3-以太网</code> 帧的首部通常是 14 个字节（6 个字节的目标 MAC 地址，6 个字节的源 MAC 地址和 2 个字节的类型/长度字段）。帧尾部是 4 个字节的校验和字段。<a href=https://en.wikipedia.org/wiki/Ethernet_frame#Ethernet_II target=_blank rel="noopener noreferrer">Ethernet frame - Wikipedia</a></p><p>因此，整个以太网帧的首部和尾部共占据 18 个字节的空间。<strong>VLAN 等衍生技术可能会增加额外字节</strong></p><h6 id=wifi class=headerLink><a href=#wifi class=header-mark></a>WIFI</h6><p><code>IEEE 802.11</code> 的帧结构在设计上考虑了无线信道特性、多跳传输、移动性以及安全性等因素，以适应无线局域网环境中的需求。<a href=https://en.wikipedia.org/wiki/IEEE_802.11 target=_blank rel="noopener noreferrer">IEEE 802.11 - Wikipedia</a></p><p><img src=/posts/%E9%99%84%E4%BB%B6/WIFI-frame%E7%BB%86%E8%8A%82.png></p><p>最小是 <strong>32 字节</strong>,最小的组成为:</p><ol><li>帧头部（Frame Header）：帧头部的长度为 28 个字节，包含以下字段：<ul><li>Frame Control：2 个字节，用于指示帧类型、子类型和其他控制信息。</li><li>Duration/ID：2 个字节，用于指示帧的持续时间或标识符。</li><li>Address 1-4：每个地址字段占 6 个字节，用于指示目标 MAC 地址、源 MAC 地址和其他相关地址。</li><li>Sequence Control：0 或 2 个字节，用于指示帧的序列号和片段编号。</li><li>Qos: 0 或 2 字节,流控</li><li>HT Controler: 0 或 4 字节,高吞吐量</li></ul></li><li>帧尾部（Frame Footer）：帧尾部的长度为 4 个字节，包含 FCS（Frame Check Sequence）字段，用于进行帧的差错检测。</li></ol><p>不同的原因:</p><ol><li><p>帧类型字段：
Wi-Fi 帧中包含一个帧类型字段，用于指示该帧的类型。帧类型字段可以表示数据帧、控制帧或管理帧。这有助于 Wi-Fi 设备在接收到帧时正确处理和解释其目的和功能。</p></li><li><p>MAC 地址格式：
以太网使用 6 字节的 MAC 地址来唯一标识网络设备，而 Wi-Fi 引入了扩展的 MAC 地址格式。Wi-Fi 的帧首部包含 4 字节的接收者 MAC 地址和 4 字节的发送者 MAC 地址。这样的设计支持更复杂的无线网络拓扑，例如多跳传输和移动设备的漫游。</p></li><li><p>序列控制字段：
Wi-Fi 帧中包含一个序列控制字段，用于维护帧的传输顺序和可靠性。序列控制字段包括分片编号、片段计数和帧序列号等信息，以确保帧在无线信道上传输和组装时的正确顺序。</p></li><li><p>帧校验序列（FCS）：
以太网帧使用循环冗余校验（CRC）字段来检测帧的传输错误，而 Wi-Fi 帧使用一个更复杂的 FCS 字段来实现错误检测。FCS 字段包含了更强大的校验算法，以提高对无线信道上的干扰和误码的容错能力。</p></li></ol><h5 id=mtu class=headerLink><a href=#mtu class=header-mark></a>MTU</h5><p>MTU 如果设置太大, 可能被路由器拒绝转发. 太小又会导致效率低.<img src=/posts/%E9%99%84%E4%BB%B6/%E5%B8%B8%E7%94%A8%E7%BD%91%E7%BB%9C%E7%9A%84MTU%E5%80%BC.png></p><p><a href=/posts/%E7%AC%94%E8%AE%B0/point/windows/>windows</a> 查看 MTU <code>netsh.exe interface ipv4 show subinterfaces</code> <img src=/posts/%E9%99%84%E4%BB%B6/windows%E6%9F%A5%E7%9C%8Bmtu.png></p><p><a href=/posts/%E7%AC%94%E8%AE%B0/point/linux/>linux</a> 查看 MTU <code>ip a</code><img src=/posts/%E9%99%84%E4%BB%B6/linux%E6%9F%A5%E7%9C%8Bmtu.png></p><h4 id=网络层 class=headerLink><a href=#%e7%bd%91%e7%bb%9c%e5%b1%82 class=header-mark></a>网络层</h4><h5 id=tcp-ip-协议栈 class=headerLink><a href=#tcp-ip-%e5%8d%8f%e8%ae%ae%e6%a0%88 class=header-mark></a>TCP-IP 协议栈</h5><p><img src=/posts/%E9%99%84%E4%BB%B6/TCP-IP%E5%8D%8F%E8%AE%AE%E6%A0%88.png></p><h5 id=ip-数据报格式 class=headerLink><a href=#ip-%e6%95%b0%e6%8d%ae%e6%8a%a5%e6%a0%bc%e5%bc%8f class=header-mark></a>IP 数据报格式</h5><p><img src=/posts/%E9%99%84%E4%BB%B6/IP%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F.png></p><ul><li>版本：占 4 位，指 IP 协议的版本。（IPv4/IPv6）</li><li>首部长度：占 4 位，单位是 4B，最小为 5（因为首部固定部分 20B，5 * 4B = 20B），最大为 15（15 * 4B = 60B）</li><li>区分服务：占 8 位，用来获取更好的服务（如：优先级），但实际上一直没有用过</li><li>总长度：占 16 位，首部 + 数据部分的总长度，单位是 1B，因此数据报的总长度为</li><li>标识/标志/片偏移是分片专用. <a href=/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/#IP%20%E6%95%B0%E6%8D%AE%E6%8A%A5%E5%88%86%E7%89%87>IP 数据报分片</a></li><li>生存时间（TTL）：占 8 位，IP 分组的保质期，经过一个路由器就 -1，变为 0 则丢弃</li><li>协议：占 8 位，数据部分的协议，即传输层使用的是什么协议</li><li>首部检验和：占 16 位，只检验数据报的首部，但不包含数据部分。每经过一个路由器，都会重新计算一下首部检验和。</li><li>源地址：占 32 位</li><li>目的地址：占 32 位</li><li>可选字段：占 0 ~ 40 位，用来支持排错、测量以及安全措施</li><li>填充：全 0，把首部长度补成 4B 的整数倍</li></ul><table><thead><tr><th>协议名</th><th>ICMP</th><th>IGMP</th><th>TCP</th><th>EGP</th><th>IGP</th><th>UDP</th><th>IPv6</th><th>ESP</th><th>OSPF</th></tr></thead><tbody><tr><td>字段值</td><td>1</td><td>2</td><td><strong>6</strong></td><td>8</td><td>9</td><td><strong>17</strong></td><td>41</td><td>50</td><td>89</td></tr></tbody></table><h5 id=ip-数据报分片 class=headerLink><a href=#ip-%e6%95%b0%e6%8d%ae%e6%8a%a5%e5%88%86%e7%89%87 class=header-mark></a>IP 数据报分片</h5><p>由于 MTU 最大 1500 的限制, 如果发送大于 1500-20 (ip 头部最小为 20 byte)=1480 的数据, 就需要分片.<strong>不会考虑 TCP 头, 也就是说 TCP 头只会在第一个分片中存在.</strong></p><ul><li>标识：占 16 位，同一数据报的分片使用同一标识</li><li>标志：占 3 位，只有两位有意义 x _ _<ul><li>中间位 DF（Don&rsquo;t Fragment）<ul><li>DF = 1，禁止分片</li><li>DF = 0，允许分片</li></ul></li><li>最低位 MF（More Fragment）<ul><li>MF = 1，后面还有分片</li><li>MF = 0，代表最后一片 / 没分片</li></ul></li></ul></li><li>片偏移：指出较长分组分片后，某片在原分组中的相对位置。（以 8B 为单位）<ul><li><strong>除了最后一片，每个分片长度一定是 8B 的整数倍</strong></li></ul></li></ul><p>假设我要发送 3800 byte 的数据,tcp 头 24 byte,组成的数据包 3824 byte.</p><p>最大数据量为 1500-24 = 1476 byte. 要被 8 整除. 所以最大数据量为 1472/8=184 .</p><p>3800 / 1472 = 2.58&mldr;. = 3 次.</p><table><thead><tr><th>数据</th><th>总长度</th><th>标识</th><th>MF</th><th>DF</th><th>片偏移</th></tr></thead><tbody><tr><td>原始数据包</td><td>3800+24=3824</td><td>12345</td><td>0</td><td>0</td><td>0</td></tr><tr><td>数据包 1</td><td>1472+24=1496</td><td>12345</td><td>1</td><td>0</td><td>0</td></tr><tr><td>数据包 2</td><td>1472+24=1496</td><td>12345</td><td>1</td><td>0</td><td>184</td></tr><tr><td>数据包 3</td><td>856+24=880</td><td>12345</td><td>0</td><td>0</td><td>368</td></tr></tbody></table><h5 id=私有-ip-地址 class=headerLink><a href=#%e7%a7%81%e6%9c%89-ip-%e5%9c%b0%e5%9d%80 class=header-mark></a>私有 IP 地址</h5><table><thead><tr><th>CIDR 标识</th><th>地址范围</th><th>IP 个数</th></tr></thead><tbody><tr><td>10.0.0.0/8</td><td>10.0.0.0~10.255.255.255</td><td>16,777,216</td></tr><tr><td>172.16.0.0/12</td><td>172.16.0.0~172.31.255.255</td><td>1,048,576</td></tr><tr><td>192.168.0.0/16</td><td>192.168.0.0~192.168.255.255</td><td>65,536</td></tr></tbody></table><h5 id=arprarp-协议 class=headerLink><a href=#arprarp-%e5%8d%8f%e8%ae%ae class=header-mark></a>ARP/RARP 协议</h5><ul><li>ARP: 通过 ip 获取物理 mac 地址. 发送 arp 广播, 目标机器响应结果. 此协议互信, 所以可以伪造 ARP 响应包, 目标一旦缓存了错误的数据, 目标就会将数据发送给伪造者.</li><li>RARP: 通过 mac 地址获取 ip 地址. 广播 mac 地址, RARP 服务器检查后, 返回 IP 地址, 不存在则不响应.</li></ul><h5 id=dhcp-协议 class=headerLink><a href=#dhcp-%e5%8d%8f%e8%ae%ae class=header-mark></a>DHCP 协议</h5><p>DHCP 协议过程：</p><ol><li>主机广播 DHCP 发现报文
“有没有 DHCP 服务器呀” 试图找到网络中的服务器，向服务器获得一个 IP 地址</li><li>DHCP 服务器广播 DHCP 提供报文
“有！有！有！” 服务器拟分配给主机一个 IP 地址及相关配置，先到先得</li><li>主机广播 DHCP 请求报文
“我用你给我的 IP 地址啦？” 主机向服务器请求提供 IP 地址</li><li>DHCP 服务器广播 DHCP 确认报文
“用吧！” 正式将 IP 地址分配给主机</li></ol><h5 id=icmp-协议 class=headerLink><a href=#icmp-%e5%8d%8f%e8%ae%ae class=header-mark></a>ICMP 协议</h5><ul><li>Ping 测试连通性. 发送数据包, 通常远端会返回响应. 但防火墙之类的也可以不响应.</li><li>Tracertoute 跟踪数据包流转的路径. 每次经过节点都会 ttl-1 .同时如果为 0, 当前节点就会返回响应. 所以可以不断尝试, 拿到路由路径.</li></ul><h4 id=传输层 class=headerLink><a href=#%e4%bc%a0%e8%be%93%e5%b1%82 class=header-mark></a>传输层</h4><h5 id=udp class=headerLink><a href=#udp class=header-mark></a>UDP</h5><ul><li>UDP 是无连接的，减少开销和发送数据之间的时延</li><li>UDP 使用最大努力交付，即不保证可靠交付</li><li>UDP 是面向报文的，适合一次性传输少量数据的网络应用. 对于应用层交付的报文，直接原封不动的封装到 UDP 数据报的数据部分，即一次发一个完整的报文</li><li>UDP 无拥塞控制，适合很多实时应用. 例如直播</li><li>UDP 首部开销很小，8 byte，TCP 需要 20 byte</li></ul><p>UDP 的头部格式</p><p><img src=/posts/%E9%99%84%E4%BB%B6/UDP%E5%A4%B4%E9%83%A8%E6%A0%BC%E5%BC%8F.png></p><h5 id=tcp class=headerLink><a href=#tcp class=header-mark></a>TCP</h5><h6 id=tcp-的头部格式 class=headerLink><a href=#tcp-%e7%9a%84%e5%a4%b4%e9%83%a8%e6%a0%bc%e5%bc%8f class=header-mark></a>TCP 的头部格式</h6><p><img src=/posts/%E9%99%84%E4%BB%B6/TCP%E7%9A%84%E5%A4%B4%E9%83%A8%E6%A0%BC%E5%BC%8F.png></p><p><strong>头部最小 20 字节, 也就是说发送 1 字节的数据, ip 头 +tcp 头需要 41 字节.</strong></p><ul><li>**序号（seq）：**在一个 TCP 连接中传送的字节流中的每一个字节都按序编号，本字段表示本报文段所发送数据的第一个字节的序号</li><li>**确认号（ack）：**期望收到对方下一个报文段的第一个数据字节的序号。如果确认号为 N，则证明到序号 N - 1 为止的所有数据都已正确收到</li><li>**数据偏移（首部长度）：**TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远，以 4B 为单位，即 1 个数值是 4B</li><li>**紧急位 URG：**URG = 1 时，表示此报文段中有紧急数据，是高优先级的数据，应尽快传送，不用再缓存里排队，配合紧急指针字段使用</li><li>**确认位 ACK：**ACK = 1 时确认号有效，在连接建立之后所有传送的报文段都必须把 ACK 置为 1</li><li>**推送位 PSH：**PSH = 1 时，接收方尽快交付接受应用程序，不再等到缓存填满再向上交付（和紧急位是对应的，紧急位是发送发优先发送，推送位是接收方优先向上交付）</li><li><strong>复位 RST：<strong>RST = 1 时，表明 TCP 连接中出现严重差错，必须释放连接，然后再</strong>重新建立传输连接</strong></li><li><strong>同步位 SYN：<strong>SYN = 1 时，表明是一个</strong>连接请求</strong>/<strong>连接接收报文</strong></li><li>**终止位 FIN：**FIN = 1 时，表明此报文段发送方数据已发送完，要求释放连接</li><li>**窗口：**指发送本报文段的一方的接收窗口，即现在允许对方发送的数据量</li><li>**检验和：**检验首部 + 数据，检验时要加上 12B 伪首部，伪首部第四个字段是 6</li><li>**紧急指针：**URG = 1 时才有意义，指出本报文段中紧急数据的字节数</li><li>**选项：**最大报文段长度 MSS、窗口扩大、时间戳、选择确认&mldr;&mldr;</li></ul><h6 id=tcp-options-相关参数 class=headerLink><a href=#tcp-options-%e7%9b%b8%e5%85%b3%e5%8f%82%e6%95%b0 class=header-mark></a>TCP-options 相关参数</h6><table><thead><tr><th>Kind</th><th>Length</th><th>Info</th></tr></thead><tbody><tr><td>1 字节</td><td>1 字节 (可选)</td><td>n 字节 (可选)</td></tr></tbody></table><p><img src=/posts/%E9%99%84%E4%BB%B6/tcp-options%E5%9B%BE.png></p><ul><li>图中第一个字段是 <code>MSS-Maximum Segment Size 最大报文长度</code></li><li>第二个字段一个空的选项, 用于补齐 tcp 头部为 4 byte 的整数倍</li></ul><h6 id=tcp-建立连接 class=headerLink><a href=#tcp-%e5%bb%ba%e7%ab%8b%e8%bf%9e%e6%8e%a5 class=header-mark></a>TCP 建立连接</h6><p><img src=/posts/%E9%99%84%E4%BB%B6/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png></p><p>刚开始客户端处于 <strong>closed 状态</strong>，服务端处于 <strong>listen 状态</strong></p><ol><li>**第一次握手：**客户端发送连接请求报文段（<strong>SYN = 1，seq = x（随机）</strong>），无应用层数据。此时客户端处于 <strong>SYN_Send （同步发送）状态</strong></li><li>**第二次握手：**服务端收到客户端的连接请求报文后，为该 TCP 连接分配缓存和变量，并向客户端返回确认报文（<strong>SYN = 1，ACK = 1，seq = y（随机），ack = x + 1</strong>），允许连接，无应用层数据。此时服务端处于 <strong>SYN_REVD（同步接收）状态</strong></li><li><strong>第三次握手：<strong>客户端收到连接请求报文后，会发送一个对确认的确认报文（<strong>ACK = 1，seq = x + 1，ack = y + 1</strong>），<strong>可以携带数据</strong>。此时客户端</strong>处于 established 状态</strong></li></ol><p>服务器收到确认报文后，也会<strong>处于 established 状态</strong>。此时，双方建立了连接.</p><p>SYN 哄泛攻击:</p><ol><li>攻击者发送握手第一个包</li><li>服务器响应后, 处于半连接. 发送消耗资源, 挂起消耗资源</li><li>服务器收不到响应, 重复发送, 持续消耗资源</li><li>短时间内服务器大量等待, 会崩掉</li></ol><h6 id=tcp-连接释放 class=headerLink><a href=#tcp-%e8%bf%9e%e6%8e%a5%e9%87%8a%e6%94%be class=header-mark></a>TCP 连接释放</h6><p><img src=/posts/%E9%99%84%E4%BB%B6/TCP%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png></p><p>刚开始双方都处于 established 状态，假如是客户端先发起关闭请求，则：</p><ol><li>第一次挥手：客户端发送<strong>连接释放报文段</strong>（<strong>FIN = 1，seq = u（前面已传送数据的最后一个字节序号 + 1）</strong>），停止发送数据，主动关闭 TCP 连接。此时客户端处于 <strong>FIN-WAIT-1 状态</strong></li><li>第二次挥手：服务端收到 FIN 报文后，返回一个确认报文段（<strong>ACK = 1，seq = v，ack = u + 1</strong>）。此时服务端处于 <strong>CLOSE-WAIT 状态</strong></li><li>第三次挥手：服务端发完数据，就发出连接释放报文段（<strong>FIN = 1，ACK = 1，seq = w，ack = u + 1</strong>），主动关闭 TCP 连接。此时服务端处于 <strong>LAST-ACK 状态</strong></li><li>第四次挥手：客户端返回一个确认报文段（<strong>ACK = 1，seq = u + 1，ack = w + 1</strong>），再等到时间等待计时器设置的 2MSL（最长报文段寿命）后，连接彻底关闭</li></ol><h2 id=faq class=headerLink><a href=#faq class=header-mark></a>FAQ</h2><h3 id=tcp-segment-段和-package-包 class=headerLink><a href=#tcp-segment-%e6%ae%b5%e5%92%8c-package-%e5%8c%85 class=header-mark></a>TCP segment 段和 package 包</h3><p>在 TCP（传输控制协议）中，&ldquo;Segment size&rdquo;（段大小）和 &ldquo;Packet&rdquo;（包）是两个不同但相关的概念。</p><p>&ldquo;Segment size&rdquo; 指的是 TCP 协议中数据传输时每个 TCP 段（segment）的最大大小。TCP 使用分段（segmentation）将应用程序发送的数据划分为较小的片段进行传输。这些片段被称为 TCP 段，每个段都包含一个 TCP 头部和有效载荷（数据）。段的大小由操作系统或网络堆栈的配置参数确定，并且可以根据网络条件进行调整。通常情况下，段的大小在几百字节到几千字节之间。</p><p>而 &ldquo;Packet&rdquo;（包）是在网络层（如互联网协议 IP）上进行数据传输时使用的单位。包是由网络层负责封装和传递的，其中包括源地址、目标地址和有效载荷（即从传输层接收到的 TCP 段）。包的大小由网络层协议定义，例如在 IPv4 中，包的最大大小为 64KB。</p><p>区别：</p><ol><li>概念层次不同：TCP 段是在传输层协议 TCP 中定义的，而包是在网络层协议（如 IP）中定义的。</li><li>功能不同：TCP 段负责将数据从应用程序发送到接收方的 TCP 协议栈，而包在网络中进行路由和传递，确保数据的正确交付。</li><li>大小限制不同：TCP 段的大小受到 TCP 协议栈的配置参数限制，而包的大小由网络层协议定义。</li></ol><p>联系： 在传输过程中，应用程序发送的数据会被 TCP 协议分割成多个段（segment），每个段都会被封装为一个网络层的包（packet）进行传输。这两个概念都是为了实现可靠的数据传输和网络通信而存在的。</p><h3 id=tcp_cork-和-tcp_nodelay class=headerLink><a href=#tcp_cork-%e5%92%8c-tcp_nodelay class=header-mark></a>TCP_CORK 和 TCP_NODELAY</h3><p><strong>Nagle 算法规定包满足 MSS 立即发送, 否则需要发送 ACK 确认包.</strong> 而每个包都发送 ACK, 会降低性能.</p><p><code>DelayedAcknowledgment</code> 不再针对单个包发送 ACK，而是<strong>一次确认两个包，或者在发送响应数据的同时捎带着发送 ACK，又或者触发超时时间后再发送 ACK</strong>.</p><p>而一旦这两点同时工作, 在发送小包的时候, 就需要等待 ack 回传, 才能发送. 为什么一般延迟是 40 ms 呢? <a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_for_real_time/7/html/tuning_guide/reducing_the_tcp_delayed_ack_timeout target=_blank rel="noopener noreferrer">redhat文档说默认是这个值</a>, <a href=https://www.rfc-editor.org/rfc/rfc9293.html#name-delayed-acknowledgments-whe target=_blank rel="noopener noreferrer">RFC 9293</a> 说必须少于 0.5 seconds, 所以设置的 40 ms 吧.</p><p>如何解决呢? 启用 TCP_NODELAY , 禁用 Nagle 算法. <a href=/posts/%E7%AC%94%E8%AE%B0/nginx%E9%85%8D%E7%BD%AE/#nginx.conf%20%E4%B8%BB%E9%85%8D%E7%BD%AE>nginx配置</a> 就用了这个配置. 其中</p><ul><li>TCP_NOPUSH 就是 <a href=https://linux.die.net/man/7/tcp target=_blank rel="noopener noreferrer">TCP_CORK</a> 参数, 可以和 TCP_DELAY 配置使用, 让 nginx 在发送文件的时候每个包尽量多的存放数据.</li><li><a href=https://linux.die.net/man/7/tcp target=_blank rel="noopener noreferrer">TCP_NODELAY</a> 就是在其他情况下, 减少延迟用的.</li></ul><blockquote><p>参考资料
<a href=https://www.cnblogs.com/wajika/p/6573014.html target=_blank rel="noopener noreferrer">TCP_NODELAY 和 TCP_NOPUSH的解释 - wajika - 博客园</a></p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-07-17</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/ data-title=网络知识 data-hashtags=blog,网络知识><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Facebook" data-sharer=facebook data-url=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/ data-hashtag=blog><span class="fab fa-facebook-square fa-fw"></span></button><button title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/ data-title=网络知识 data-web><span class="fab fa-whatsapp fa-fw"></span></button><button title="分享到 Line" data-sharer=line data-url=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/ data-title=网络知识><span data-svg-src=/lib/simple-icons/icons/line.min.svg></span></button><button title="分享到 微博" data-sharer=weibo data-url=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/ data-title=网络知识><span class="fab fa-weibo fa-fw"></span></button><button title="分享到 Myspace" data-sharer=myspace data-url=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/ data-title=网络知识 data-description="这里记录一些 ip, 包, 传输协议, 段, 和7 层网络知识等等网络知识, 方便快速查阅. "><span data-svg-src=/lib/simple-icons/icons/myspace.min.svg></span></button><button title="分享到 Blogger" data-sharer=blogger data-url=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/ data-title=网络知识 data-description="这里记录一些 ip, 包, 传输协议, 段, 和7 层网络知识等等网络知识, 方便快速查阅. "><span class="fab fa-blogger fa-fw"></span></button><button title="分享到 Evernote" data-sharer=evernote data-url=https://kentxxq.com/posts/%E7%AC%94%E8%AE%B0/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/ data-title=网络知识><span class="fab fa-evernote fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/blog/>blog</a>,&nbsp;<a href=/tags/%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86/>网络知识</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/%E7%AC%94%E8%AE%B0/%E6%96%87%E6%A1%A3%E5%8A%A9%E6%89%8B/ class=prev rel=prev title=文档助手><i class="fas fa-angle-left fa-fw"></i>文档助手</a>
<a href=/posts/%E7%AC%94%E8%AE%B0/point/redis/ class=next rel=next title=redis>redis<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>1993 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://kentxxq.com target=_blank rel="noopener noreferrer">kentxxq</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a> | <a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=43010402000934"><img src=/备案图标.png style=display:inline-block>湘公网安备 43010402000934号</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a target=_blank href=https://beian.miit.gov.cn>湘ICP备2021002319号-1</a></span></div><div class=footer-line></div><div class=footer-line></div></div><script>"serviceWorker"in navigator&&(navigator.serviceWorker.register("/sw.min.js",{scope:"/"}).then(function(){}),navigator.serviceWorker.ready.then(function(){}))</script></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:18},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},sharerjs:!0,twemoji:!0}</script><script type=text/javascript src=/lib/twemoji/twemoji.min.js defer></script><script type=text/javascript src=/js/twemoji.min.js defer></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-NLLDC353PJ",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-NLLDC353PJ" async></script></div></body></html>