<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-131319987-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-131319987-1');</script><meta name=author content="kentxxq"><meta name=keywords content="centos gunicorn flask nginx 配置部署"><meta name=description content="centos部署web服务（可拓展）"><link rel=prev href=https://kentxxq.com/contents/vue_node%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97/><link rel=next href=https://kentxxq.com/contents/2018%E7%9A%84%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%97%A5%E8%AE%B0/><link rel=canonical href=https://kentxxq.com/contents/%E9%83%A8%E7%BD%B2web%E6%9C%8D%E5%8A%A1%E5%8F%AF%E6%8B%93%E5%B1%95/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=icon type=image/png href=/favicon.png><title>centos部署web服务（可拓展） | kentxxq Blog</title><meta name=title content="centos部署web服务（可拓展） | kentxxq Blog"><link rel=stylesheet href=/font/iconfont.css><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","image":"https:\/\/kentxxq.com\/images/me/avatar.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/kentxxq.com\/"},"articleSection":"posts","name":"centos部署web服务（可拓展）","headline":"centos部署web服务（可拓展）","description":"centos部署web服务（可拓展）","inLanguage":"zh","author":"kentxxq","creator":"kentxxq","publisher":{"@type":"Organization","name":"kentxxq","logo":{"@type":"ImageObject","url":"https:\/\/kentxxq.com\/images/me/avatar.jpg"}},"accountablePerson":"kentxxq","copyrightHolder":"kentxxq","copyrightYear":"2018","datePublished":"2018-04-17 00:00:00","dateModified":"2018-04-17 00:00:00","url":"https:\/\/kentxxq.com\/contents\/%E9%83%A8%E7%BD%B2web%E6%9C%8D%E5%8A%A1%E5%8F%AF%E6%8B%93%E5%B1%95\/","keywords":["centos","gunicorn","flask","nginx","配置部署"]}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://kentxxq.com/>kentxxq Blog</a></div><div class="menu navbar-right"><a class=menu-item href=/posts/>Blog</a>
<a class=menu-item href=/categories/>Categories</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about/>About</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://kentxxq.com/>kentxxq Blog</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=/posts/>Blog</a>
<a class=menu-item href=/categories/>Categories</a>
<a class=menu-item href=/tags/>Tags</a>
<a class=menu-item href=/about/>About</a></div></div></nav><main class=main><div class=container><article class=post-warp><header class=post-header><h1 class=post-title>centos部署web服务（可拓展）</h1><div class=post-meta>Written by <a href=https://kentxxq.com/ rel=author>kentxxq</a>
with ♥
<span class=post-time>on <time datetime=2018-04-17>April 17, 2018</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=https://kentxxq.com/categories/%E7%AC%94%E8%AE%B0/>笔记</a></span>
|
<a href=#gitalk-container><span class=gitalk-comment-count itemprop=commentCount></span></a></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#架构说明>架构说明</a></li><li><a href=#安装环境>安装环境</a></li><li><a href=#配置文件>配置文件</a></li><li><a href=#启动>启动</a></li></ul></nav></div></div><script type=text/javascript>window.onload=function(){var fix=$('.post-toc');var end=$('.post-comment');var fixTop=fix.offset().top,fixHeight=fix.height();var endTop,miss;var offsetTop=fix[0].offsetTop;$(window).scroll(function(){var docTop=Math.max(document.body.scrollTop,document.documentElement.scrollTop);if(end.length>0){endTop=end.offset().top;miss=endTop-docTop-fixHeight;}
if(fixTop<docTop){fix.css({'position':'fixed'});if((end.length>0)&&(endTop<(docTop+fixHeight))){fix.css({top:miss});}else{fix.css({top:0});}}else{fix.css({'position':'absolute'});fix.css({top:offsetTop});}})}</script><div class=post-content><blockquote><p>学习了一下如何搭建大型的web应用，可拓展到承接大量的请求</p></blockquote><h2 id=架构说明>架构说明</h2><ol><li>第一层购买域名以及云dns解析</li><li>第二层在这一个服务器搭建nginx的服务器。反向代理这一个服务器集群提供的服务</li><li>第三层在每一台服务器使用gunicorn，开启多个进程来处理flask请求</li><li>第四层flask连接到云内部的数据库，同时也就不用担心数据库的同步问题了。（费用如果很高，那说明你需求量很高，很赚钱了啊）</li></ol><blockquote><p>现在是云时代。我喜欢所有的东西都放在云上。除非是大企业在机房自建，不然够用了
域名部分我就不说了。。一般在对应的云上面找到，然后点点点就ok</p></blockquote><p><img src=/images/centos/web%E6%8B%93%E6%89%91%E5%9B%BE.png alt=大概示意图></p><h2 id=安装环境>安装环境</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 设置nginx包</span>
<span style=color:#75715e># root @ kentxxq in /etc/yum.repos.d [14:17:01]</span>
$ cat nginx.repo
<span style=color:#f92672>[</span>nginx<span style=color:#f92672>]</span>
name<span style=color:#f92672>=</span>nginx repo
baseurl<span style=color:#f92672>=</span>http://nginx.org/packages/centos/7/$basearch/
gpgcheck<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
enabled<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
<span style=color:#75715e># 安装nginx</span>
yum install nginx
<span style=color:#75715e># 安装python</span>
curl -L https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash
<span style=color:#75715e># 添加到.bash_profile的尾部</span>
export PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/root/.pyenv/bin:</span>$PATH<span style=color:#e6db74>&#34;</span>
eval <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>pyenv init -<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
eval <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>pyenv virtualenv-init -<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># 安装指定版本的python，安装所需的包</span>
pyenv install 3.6.3
pyenv global 3.6.3
<span style=color:#75715e># 安装所需要的包</span>
pip install gevent
pip install flask
pip install gunicorn
</code></pre></div><h2 id=配置文件>配置文件</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>########################</span>
<span style=color:#75715e># nginx配置文件</span>
<span style=color:#75715e>########################</span>
$ root @ kentxxq in /etc/nginx <span style=color:#f92672>[</span>14:28:10<span style=color:#f92672>]</span>
$ cat nginx.conf
<span style=color:#75715e># For more information on configuration, see:</span>
<span style=color:#75715e>#   * Official English Documentation: http://nginx.org/en/docs/</span>
<span style=color:#75715e>#   * Official Russian Documentation: http://nginx.org/ru/docs/</span>

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

<span style=color:#75715e># Load dynamic modules. See /usr/share/nginx/README.dynamic.</span>
include /usr/share/nginx/modules/*.conf;

events <span style=color:#f92672>{</span>
    worker_connections 1024;
<span style=color:#f92672>}</span>

http <span style=color:#f92672>{</span>
    log_format  main  <span style=color:#e6db74>&#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;</span>
                      <span style=color:#e6db74>&#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;</span>
                      <span style=color:#e6db74>&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span>;

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    <span style=color:#75715e># Load modular configuration files from the /etc/nginx/conf.d directory.</span>
    <span style=color:#75715e># See http://nginx.org/en/docs/ngx_core_module.html#include</span>
    <span style=color:#75715e># for more information.</span>
    include /etc/nginx/conf.d/*.conf;

    upstream gunicorns <span style=color:#f92672>{</span>
        server 127.0.0.1:8080;
    <span style=color:#f92672>}</span>

    server<span style=color:#f92672>{</span>
        listen 80;
        <span style=color:#75715e># using web sub domain to access</span>
        server_name http://gunicorns;
        access_log  /var/log/nginx/web_access.log;

        location / <span style=color:#f92672>{</span>
            proxy_pass http://127.0.0.1:8080;
            proxy_read_timeout 300;
            proxy_connect_timeout 300;
            proxy_redirect     off;

            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   Host              $http_host;
            proxy_set_header   X-Real-IP         $remote_addr;
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>




<span style=color:#75715e>########################</span>
<span style=color:#75715e># gunicorn配置文件</span>
<span style=color:#75715e>########################</span>
<span style=color:#75715e># root @ kentxxq in ~ [14:29:23]</span>
$ cat gunicorn.py
<span style=color:#75715e># coding:utf-8</span>
import multiprocessing


<span style=color:#75715e>#绑定到的ip地址和端口</span>
bind<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;127.0.0.1:8080&#34;</span>

<span style=color:#75715e>#这是一个不阻塞的,默认sync性能不够好</span>
worker_class <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;gevent&#39;</span>

<span style=color:#75715e>#线程数量.推荐是cpu数量*2+1个.</span>
<span style=color:#75715e>#一般来说48核心的cpu机器还没12个4核心机器好,如果坏了一台还有11台能用</span>
workers <span style=color:#f92672>=</span> multiprocessing.cpu_count<span style=color:#f92672>()</span> * <span style=color:#ae81ff>2</span> + <span style=color:#ae81ff>1</span>


<span style=color:#75715e>#默认是1,改成2吧</span>
<span style=color:#75715e>#官方推荐2-4 x $(NUM_CORES)</span>
threads <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>

<span style=color:#75715e>#日志级别:info不记录访问的日志信息</span>
loglevel <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;info&#39;</span>
<span style=color:#75715e>#错误日志的路径</span>
errorlog<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/var/log/gunicorn.log&#39;</span>
<span style=color:#75715e>#pid文件,作用是记录pid..</span>
<span style=color:#75715e>#不过我一般用 ps -ef|grep gunicorn来查看主进程,然后kill -term 主线程pid  来关闭..</span>
pidfile<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/var/log/gunicorn.pid&#39;</span>

<span style=color:#75715e>#任何代码的变动,都会重新reload项目</span>
reload<span style=color:#f92672>=</span>True

<span style=color:#75715e>#连接超时</span>
timeout<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>

<span style=color:#75715e>#把任务变成后台的守护进程.不收到终端关闭的影响</span>
daemon<span style=color:#f92672>=</span>True




<span style=color:#75715e>########################</span>
<span style=color:#75715e># flask文件</span>
<span style=color:#75715e>########################</span>
<span style=color:#75715e># root @ kentxxq in ~ [14:30:31]</span>
$ cat test.py
<span style=color:#75715e># coding:utf-8</span>

from flask import Flask
app <span style=color:#f92672>=</span> Flask<span style=color:#f92672>(</span>__name__<span style=color:#f92672>)</span>

@app.route<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;/&#39;</span><span style=color:#f92672>)</span>
def hello_world<span style=color:#f92672>()</span>:
    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;Hello, World!&#39;</span>
</code></pre></div><h2 id=启动>启动</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># 按照指定的参数，启动flask</span>
gunicorn -c gunicorn.py
<span style=color:#75715e># 启动nginx代理</span>
systemctl start nginx
</code></pre></div><blockquote><p>其实我可以用systemd和supervisor来帮助我启动服务。但是supervisor还没有发布python3的版本，而systemd我不是太喜欢，且不支持web来操作。。所以后续再更新吧。。</p></blockquote></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>kentxxq</span></p><p class=copyright-item><span>Link:</span>
<a href=https://kentxxq.com/contents/%E9%83%A8%E7%BD%B2web%E6%9C%8D%E5%8A%A1%E5%8F%AF%E6%8B%93%E5%B1%95/><script>document.write(decodeURI(location.origin+location.pathname))</script></a></p><p class="copyright-item lincese">本文采用<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://kentxxq.com/tags/centos/>#centos</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://kentxxq.com/>home</a></span></section></div><div class=post-nav><a href=https://kentxxq.com/contents/vue_node%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97/ class=prev rel=prev title=vue_node学习系列><i class="iconfont icon-left"></i>&nbsp;vue_node学习系列</a>
<a href=https://kentxxq.com/contents/2018%E7%9A%84%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%97%A5%E8%AE%B0/ class=next rel=next title=2018的一句话日记>2018的一句话日记&nbsp;<i class="iconfont icon-right"></i></a></div></article><div class=post-comment><div id=disqus_thread></div><script>var disqus_config=function(){this.page.title="centos部署web服务（可拓展）"
this.page.url="https://kentxxq.com/contents/%E9%83%A8%E7%BD%B2web%E6%9C%8D%E5%8A%A1%E5%8F%AF%E6%8B%93%E5%B1%95/"};(function(){var d=document,s=d.createElement('script');s.src='https://kentxxq.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by
Disqus.</a></noscript></div></div></main><footer class=footer></footer><link href=//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css rel=stylesheet><script src=/js/vendor_gallery.min.js async></script><script src=https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js></script></div></body></html>