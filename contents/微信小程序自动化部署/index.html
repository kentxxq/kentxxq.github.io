<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-131319987-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-131319987-1')</script><meta name=author content="kentxxq"><meta name=keywords content="ansible jenkins 微信开发者工具 小程序 自动化部署"><meta name=description content="公司先阶段使用的是通过ansible来进行多服务器的部署。而微信小程序开发者工具官方只放出来了windows和mac版本。macOS老早就听说虚拟机需要超高的配置，而且也会很卡。自己也没有操作过，对mac的虚拟机没什么兴趣。估计以后也用不大上。否则也不会有那么多人去用黑苹果了。所以就开始了这次在windows机器上的踩坑之旅"><meta property="og:title" content="微信小程序自动化部署"><meta property="og:description" content="公司先阶段使用的是通过ansible来进行多服务器的部署。而微信小程序开发者工具官方只放出来了windows和mac版本。macOS老早就听说虚拟机需要超高的配置，而且也会很卡。自己也没有操作过，对mac的虚拟机没什么兴趣。估计以后也用不大上。否则也不会有那么多人去用黑苹果了。所以就开始了这次在windows机器上的踩坑之旅"><meta property="og:type" content="article"><meta property="og:url" content="https://kentxxq.com/contents/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-25T10:00:00+08:00"><meta property="article:modified_time" content="2021-02-26T00:06:04+08:00"><link rel=prev href=https://kentxxq.com/contents/ansible%E7%9A%84%E5%AD%A6%E4%B9%A0/><link rel=next href=https://kentxxq.com/contents/%E4%B8%80%E4%B8%AA%E6%88%91%E9%9C%80%E8%A6%81%E7%9A%84win10/><link rel=canonical href=https://kentxxq.com/contents/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=icon type=image/png href=/favicon.png><title>微信小程序自动化部署 | kentxxq Blog</title><meta name=title content="微信小程序自动化部署 | kentxxq Blog"><link rel=stylesheet href=/font/iconfont.css><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","image":"https:\/\/kentxxq.com\/images/me/avatar.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/kentxxq.com\/"},"articleSection":"posts","name":"微信小程序自动化部署","headline":"微信小程序自动化部署","description":"公司先阶段使用的是通过ansible来进行多服务器的部署。而微信小程序开发者工具官方只放出来了windows和mac版本。macOS老早就听说虚拟机需要超高的配置，而且也会很卡。自己也没有操作过，对mac的虚拟机没什么兴趣。估计以后也用不大上。否则也不会有那么多人去用黑苹果了。所以就开始了这次在windows机器上的踩坑之旅","inLanguage":"zh","author":"kentxxq","creator":"kentxxq","publisher":{"@type":"Organization","name":"kentxxq","logo":{"@type":"ImageObject","url":"https:\/\/kentxxq.com\/images/me/avatar.jpg"}},"accountablePerson":"kentxxq","copyrightHolder":"kentxxq","copyrightYear":"2020","datePublished":"2020-02-25 10:00:00","dateModified":"2021-02-26 00:06:04","url":"https:\/\/kentxxq.com\/contents\/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2\/","keywords":["ansible","jenkins","微信开发者工具","小程序","自动化部署"]}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://kentxxq.com/>kentxxq Blog</a></div><div class="menu navbar-right"><a class=menu-item href=/posts/ title>Blog</a>
<a class=menu-item href=/categories/ title>Categories</a>
<a class=menu-item href=/tags/ title>Tags</a>
<a class=menu-item href=/about/ title>About</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://kentxxq.com/>kentxxq Blog</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=/posts/ title>Blog</a>
<a class=menu-item href=/categories/ title>Categories</a>
<a class=menu-item href=/tags/ title>Tags</a>
<a class=menu-item href=/about/ title>About</a></div></div></nav><main class=main><div class=container><article class=post-warp><header class=post-header><h1 class=post-title>微信小程序自动化部署</h1><div class=post-meta>Written by <a href=https://kentxxq.com/ rel=author>kentxxq</a>
with ♥
<span class=post-time>on <time datetime=2020-02-25>February 25, 2020</time></span>
in
<i class="iconfont icon-folder"></i>
<span class=post-category><a href=https://kentxxq.com/categories/%E7%AC%94%E8%AE%B0/>笔记</a></span>
|
<a href=#gitalk-container><span class=gitalk-comment-count itemprop=commentCount></span></a></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title></h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#基本环境介绍>基本环境介绍</a><ul><li><a href=#远程操控端ubuntu环境搭建>远程操控端Ubuntu环境搭建</a></li><li><a href=#win10被控端环境搭建>win10被控端环境搭建</a></li><li><a href=#在ansible脚本内配置变量>在ansible脚本内配置变量</a></li></ul></li><li><a href=#具体流程>具体流程</a></li><li><a href=#问题处理>问题处理</a><ul><li><a href=#npm-i的安装问题>npm i的安装问题</a></li><li><a href=#mini-deploy的问题>mini-deploy的问题</a></li><li><a href=#无法删除dist最终代码文件夹>无法删除dist，最终代码文件夹</a></li><li><a href=#微信机器人base64的问题>微信机器人base64的问题</a></li></ul></li><li><a href=#补充说明>补充说明</a></li></ul></nav></div></div><script type=text/javascript>window.onload=function(){var a=$('.post-toc'),b=$('.post-comment'),f=a.offset().top,d=a.height(),g=a[0].offsetTop,e,c;$(window).scroll(function(){var h=Math.max(document.body.scrollTop,document.documentElement.scrollTop);b.length>0&&(c=b.offset().top,e=c-h-d),f<h?(a.css({position:'fixed'}),b.length>0&&c<h+d?a.css({top:e}):a.css({top:0})):(a.css({position:'absolute'}),a.css({top:g}))})}</script><div class=post-content><blockquote><p>公司先阶段使用的是通过ansible来进行多服务器的部署。而微信小程序开发者工具官方只放出来了windows和mac版本。</p><p>macOS老早就听说虚拟机需要超高的配置，而且也会很卡。自己也没有操作过，对mac的虚拟机没什么兴趣。估计以后也用不大上。否则也不会有那么多人去用黑苹果了。</p><p>所以就开始了这次在windows机器上的踩坑之旅。</p></blockquote><h2 id=基本环境介绍>基本环境介绍</h2><p>本次操作是在win10上进行的。</p><p>远程操作使用的jenkins是Ubuntu系统。</p><h3 id=远程操控端ubuntu环境搭建>远程操控端Ubuntu环境搭建</h3><p>默认linux都是有python环境的。但是不一定有pip。这是python的一个包管理工具。很多需要用到的工具包，都需要用pip来进行安装。</p><p>操作步骤</p><ol><li>在Ubuntu中，可以使用<code>apt install python-pip</code>命令安装。</li><li>输入pip命令，确认安装完成。</li><li>pip install pywinrm</li></ol><h3 id=win10被控端环境搭建>win10被控端环境搭建</h3><p>由于windows和mac/linux不一样，没有ssh远程连接。所以ansible是通过pywinrm模块，进行操作的。</p><p>系统要求</p><ol><li>net要3.0以上。在powershell输入$host获取net版本。</li><li>powershell也要3.0以上。在powershell输入$psversiontable获得ps版本。</li><li>系统推荐使用win10。</li></ol><p>操作步骤</p><ol><li>set-executionpolicy remotesigned (可以用get-executionpolicy验证)</li><li>下载并使用管理员powershell运行<a href=https://github.com/ansible/ansible/blob/devel/examples/scripts/ConfigureRemotingForAnsible.ps1>此配置脚本</a></li><li>winrm quickconfig 快速配置启用</li><li>winrm set winrm/config/service &lsquo;@{AllowUnencrypted=&ldquo;true&rdquo;}&rsquo;</li><li>winrm set winrm/config/service/auth &lsquo;@{Basic=&ldquo;true&rdquo;}&rsquo;</li></ol><h3 id=在ansible脚本内配置变量>在ansible脚本内配置变量</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>[<span style=color:#a6e22e>windows</span>]
<span style=color:#ae81ff>1.1</span>.<span style=color:#ae81ff>1.1</span>

[<span style=color:#a6e22e>windows</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>vars</span>]
<span style=color:#a6e22e>ansible_ssh_user</span>=<span style=color:#a6e22e>username</span>
<span style=color:#a6e22e>ansible_ssh_pass</span>=<span style=color:#a6e22e>password</span>
<span style=color:#a6e22e>ansible_ssh_port</span>=<span style=color:#ae81ff>5985</span>
<span style=color:#a6e22e>ansible_winrm_transport</span>=<span style=color:#a6e22e>ntlm</span>
<span style=color:#a6e22e>ansible_connection</span>=<span style=color:#a6e22e>winrm</span>
<span style=color:#a6e22e>ansible_winrm_server_cert_validation</span>=<span style=color:#a6e22e>ignore</span>
</code></pre></div><h2 id=具体流程>具体流程</h2><p>由于很多东西不方便直接贴代码，所以这里列出大概的流程</p><ol><li>jenkins拉下代码以后，开始执行ansible脚本。(在jenkins内部把用户名和密码等变量写好，通过&ndash;extra-vars方式传递)</li><li>通过win_file模块创建文件夹，win_copy模块拷贝代码到windows机器上。</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>拷贝最新代码到win目录</span>
  <span style=color:#f92672>win_copy</span>:
    <span style=color:#f92672>src</span>: <span style=color:#e6db74>&#34;/local_workspace_path/&#34;</span>
    <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>D:\wechat_workspace\{{ build_number }}</span>
</code></pre></div><ol start=3><li>用win_command来安装依赖。<strong>构建代码同理</strong>。</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>在win上安装依赖</span>
  <span style=color:#f92672>win_command</span>: <span style=color:#ae81ff>cmd.exe /c npm i</span>
  <span style=color:#f92672>args</span>:
    <span style=color:#f92672>chdir</span>: <span style=color:#ae81ff>D:\wechat_workspace\{{ build_number }}</span>
</code></pre></div><ol start=4><li>开始部署</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>尝试开始部署</span>
  <span style=color:#f92672>win_command</span>: <span style=color:#ae81ff>cmd.exe /c mini-deploy</span>
  <span style=color:#f92672>args</span>: 
    <span style=color:#f92672>chdir</span>: <span style=color:#ae81ff>D:\wechat_workspace\{{ build_number }}\dist</span>
</code></pre></div><ol start=5><li>把预览图拷贝到本地</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>把生成的预览图片拷贝到本地</span>
  <span style=color:#f92672>fetch</span>:
    <span style=color:#f92672>src</span>: <span style=color:#ae81ff>D:\wechat_workspace\{{ build_number }}\dist\preview.png</span>
    <span style=color:#f92672>dest</span>: <span style=color:#e6db74>&#34;/local_workspace_path/preview.png&#34;</span>
    <span style=color:#f92672>flat</span>: <span style=color:#66d9ef>yes</span>
</code></pre></div><ol start=6><li>通过base64获取图片encode编码，md5sum获取图片的md5值。通过curl发送到企业机器人，群内就可以通过扫码进行代码代码测试了。</li></ol><h2 id=问题处理>问题处理</h2><h3 id=npm-i的安装问题>npm i的安装问题</h3><p>npm在install过程过，有需要调用node命令。因为存在微信node和本身环境的node，会出现问题，需要通过如下指令进行配置！</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>npm config set scripts-prepend-node-path true
</code></pre></div><h3 id=mini-deploy的问题>mini-deploy的问题</h3><p>mini-deploy代码中默认设置查找路径为</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>wxPaths</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;C:\\Program Files (x86)\\Tencent\\微信web开发者工具\\cli.bat&#39;</span>, <span style=color:#e6db74>&#39;C:\\Program Files\\Tencent\\微信web开发者工具\\cli.bat&#39;</span>]
</code></pre></div><p>然后去注册表<code>REG QUERY "HKLM\\SOFTWARE\\Wow6432Node\\Tencent\\微信web开发者工具</code>查询真正的安装位置，放在数组的第一位作为启动项。</p><p>由于微信开发工具默认安装到c盘，路径中包含有空格，在ansible的执行过程中，会出现报错。</p><p>于是改动到了D盘。于是路径出现了问题。</p><p>最终在wxPaths中新增了一个路径，顺利完成。</p><h3 id=无法删除dist最终代码文件夹>无法删除dist，最终代码文件夹</h3><p>长期开启小程序工具，每一次的代码都存放到不同的文件夹。只能以后再去删除了。</p><h3 id=微信机器人base64的问题>微信机器人base64的问题</h3><p>由于base64数据量大，发送的请求数据不可读。所以这个问题折腾了我差不多3个小时。</p><p>base64命令默认会有一个w参数为76，导致换行。上传后的base64数据就会与md5校验码不同。</p><p>需要添加参数，具体命令为<code>base -w 0 preview.png</code></p><h2 id=补充说明>补充说明</h2><ol><li>推荐先了解scoop，类似于centos的yum、Ubuntu的apt命令。可以很方便的安装和卸载所需的工具。例如wget、git、python、nodejs、java等常用命令。</li><li>所有win_command需要使用<code>cmd.exe /c dir</code>这样的方法调用，可以避免很多问题。</li><li>shell代码内，一对双引号，里面包一对单引号。在单引号内就可以通过$符号使用变量。</li><li>ansible的fetch可以用来同步回本地单个文件。无论是linux或windows</li></ol></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>kentxxq</span></p><p class=copyright-item><span>Link:</span>
<a href=https://kentxxq.com/contents/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/><script>document.write(decodeURI(location.origin+location.pathname))</script></a></p><p class="copyright-item lincese">本文采用<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/ target=_blank>知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://kentxxq.com/tags/server/>#server</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://kentxxq.com/>home</a></span></section></div><div class=post-nav><a href=https://kentxxq.com/contents/ansible%E7%9A%84%E5%AD%A6%E4%B9%A0/ class=prev rel=prev title=ansible的学习><i class="iconfont icon-left"></i>&nbsp;ansible的学习</a>
<a href=https://kentxxq.com/contents/%E4%B8%80%E4%B8%AA%E6%88%91%E9%9C%80%E8%A6%81%E7%9A%84win10/ class=next rel=next title=一个我需要的win10>一个我需要的win10&nbsp;<i class="iconfont icon-right"></i></a></div></article><div class=post-comment><div id=disqus_thread></div><script>var disqus_config=function(){this.page.title="微信小程序自动化部署",this.page.url="https://kentxxq.com/contents/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"};(function(){var a=document,b=a.createElement('script');b.src='https://kentxxq.disqus.com/embed.js',b.setAttribute('data-timestamp',+new Date),(a.head||a.body).appendChild(b)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by
Disqus.</a></noscript></div></div></main><footer class=footer><a href=https://beian.miit.gov.cn/ target=_blank rel="external nofollow">湘ICP备2021002319号-1</a></footer><script src=/js/vendor_no_gallery.min.js async></script><script src=https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js></script></div></body></html>